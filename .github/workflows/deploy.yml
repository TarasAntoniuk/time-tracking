name: Deploy Time Tracking

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  # Test and validation job
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Run tests with coverage
        run: mvn clean verify

      - name: Upload coverage report
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: target/site/jacoco/

      - name: Check coverage thresholds
        run: |
          echo "‚úÖ Tests passed with required coverage thresholds"

  # Deploy only if tests pass
  deploy:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Package JAR
        run: |
          mvn clean package -DskipTests
          echo "üì¶ Built artifact:"
          ls -lh target/*.jar

      - name: Setup SSH key
        env:
          SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf "%s" "$SERVER_SSH_KEY" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Prepare deployment directories
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_SSH_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            APP_DIR=/srv/apps/time-tracking
            sudo mkdir -p $APP_DIR/docker/app
            sudo chown -R deploy:deploy $APP_DIR
            echo "‚úÖ Directories ready"
          ENDSSH

      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Copy JAR to server
        run: |
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_SSH_PORT }}" \
            target/*.jar \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/srv/apps/time-tracking/docker/app/app.jar

      - name: Copy Docker files
        run: |
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_SSH_PORT }}" \
            docker/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/srv/apps/time-tracking/docker/

      - name: Copy nginx config to finance
        run: |
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_SSH_PORT }}" \
            docker/nginx/conf.d/time-tracking.conf \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/srv/apps/finance/docker/nginx/conf.d/time-tracking.conf

      - name: Reload nginx
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_SSH_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            docker restart finance-nginx
            echo "‚úÖ Nginx reloaded"
          ENDSSH

      - name: Deploy application
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_SSH_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd /srv/apps/time-tracking/docker
          
            echo "üîÑ Stopping old containers..."
            docker compose stop time-tracking-app || true
            docker rm time-tracking-app || true
          
            echo "üöÄ Starting Time Tracking API..."
            docker compose up -d --build
          
            echo "‚úÖ Deployment completed"
          ENDSSH

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -p ${{ secrets.SERVER_SSH_PORT }} \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          
            echo "üì¶ Running containers:"
            docker ps | grep time-tracking
          
            echo ""
            echo "üè• Health check (with retry)..."
            SUCCESS=false
            for i in {1..30}; do
              if curl -f https://timetracking.tarasantoniuk.com/api/employees 2>/dev/null; then
                echo ""
                echo "‚úÖ Time Tracking API is healthy!"
                SUCCESS=true
                break
              fi
              echo "‚è≥ Attempt $i/30 - waiting for application..."
              sleep 2
            done
          
            if [ "$SUCCESS" = true ]; then
              exit 0
            else
              echo ""
              echo "‚ùå Health check failed after 60 seconds"
              echo "üìã Application logs:"
              docker logs time-tracking-app --tail 50
              exit 1
            fi
          ENDSSH

      - name: Deployment summary
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Time Tracking deployment completed successfully!"
            echo "üåê API: https://timetracking.tarasantoniuk.com/api/employees"
            echo "üìö Swagger: https://timetracking.tarasantoniuk.com/swagger-ui.html"
          else
            echo "‚ùå Deployment failed! Check logs above."
          fi